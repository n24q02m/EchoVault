# EchoVault Docker Compose
# Run EchoVault with X11 forwarding on unsupported Linux distributions

services:
  echovault:
    image: echovault
    build:
      context: .
      dockerfile: Dockerfile
    container_name: echovault

    # X11 forwarding configuration
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=/tmp/.Xauthority
      # D-Bus for notifications
      - DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus
      # Browser for OAuth - use host's default browser
      - BROWSER=${BROWSER:-xdg-open}

    volumes:
      # X11 socket for display
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-$HOME/.Xauthority}:/tmp/.Xauthority:ro

      # D-Bus socket for notifications
      - /run/user/1000/bus:/run/user/1000/bus:ro

      # Persistent data
      - echovault-config:/home/echovault/.config/echovault
      - echovault-data:/home/echovault/.local/share/echovault

      # Rclone config - mount read-write so token can be auto-refreshed
      # NOTE: When running with sudo, $HOME may resolve to /root instead of user home.
      # Use RCLONE_CONFIG_DIR env var or ensure rclone.conf exists in the resolved path.
      - ${RCLONE_CONFIG_DIR:-${HOME}/.config/rclone}:/home/echovault/.config/rclone:rw

    # Network mode for D-Bus access
    network_mode: host

    # Security options
    security_opt:
      - seccomp:unconfined

    # IPC for shared memory (required for some GUI apps)
    ipc: host

    # Device access for GPU acceleration (optional)
    devices:
      - /dev/dri:/dev/dri

    # Restart policy
    restart: unless-stopped

volumes:
  echovault-config:
    name: echovault-config
  echovault-data:
    name: echovault-data
