name: CD

on:
  push:
    branches: [dev, main]
  workflow_dispatch:
    inputs:
      action:
        description: "Select action"
        required: true
        default: "promote-to-stable"
        type: choice
        options:
          - promote-to-stable

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: cd-${{ github.repository }}
  cancel-in-progress: false

jobs:
  # Job: Promote dev to main (manual trigger only)
  promote:
    name: Promote to Stable
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'promote-to-stable'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Check CI/CD status on dev branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/check-ci-cd-status.sh
          ./.github/scripts/check-ci-cd-status.sh --branch=dev

      - name: Merge dev to main
        env:
          AUTO_RESOLVE_FILES: "CHANGELOG.md,package.json,Cargo.toml,Cargo.lock,apps/tauri/Cargo.toml,apps/web/package.json"
        run: |
          chmod +x .github/scripts/merge-with-auto-resolve.sh
          ./.github/scripts/merge-with-auto-resolve.sh --source=dev --target=main --files="$AUTO_RESOLVE_FILES"

  # Job: Semantic Release (on push to dev or main)
  release:
    name: Semantic Release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.semantic.outputs.new_release_published }}
      version: ${{ steps.semantic.outputs.new_release_version }}
      is_prerelease: ${{ contains(github.ref, 'dev') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Create dummy binaries
        run: |
          mkdir -p apps/tauri/binaries
          touch apps/tauri/binaries/rclone-x86_64-unknown-linux-gnu

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm build

      - name: Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release --dry-run > release-output.txt 2>&1 || true
          if grep -q "Published release" release-output.txt || grep -q "Release notes" release-output.txt; then
            pnpm release
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LATEST_TAG" ]; then
              echo "new_release_published=true" >> "$GITHUB_OUTPUT"
              echo "new_release_version=${LATEST_TAG#v}" >> "$GITHUB_OUTPUT"
            else
              echo "new_release_published=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "new_release_published=false" >> "$GITHUB_OUTPUT"
          fi

  # Job: Build Tauri apps
  build-tauri:
    name: Build Tauri (${{ matrix.bundle_name }})
    needs: release
    if: needs.release.outputs.released == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - separate jobs to ensure correct __TAURI_BUNDLE_TYPE patching
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            rclone_url: https://downloads.rclone.org/rclone-current-linux-amd64.zip
            rclone_binary: rclone-x86_64-unknown-linux-gnu
            crsqlite_url: https://github.com/vlcn-io/cr-sqlite/releases/download/v0.16.3/crsqlite-linux-x86_64.zip
            crsqlite_binary: crsqlite-x86_64-unknown-linux-gnu.so
            bundle_name: linux-deb
            bundle_args: --bundles deb
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            rclone_url: https://downloads.rclone.org/rclone-current-linux-amd64.zip
            rclone_binary: rclone-x86_64-unknown-linux-gnu
            crsqlite_url: https://github.com/vlcn-io/cr-sqlite/releases/download/v0.16.3/crsqlite-linux-x86_64.zip
            crsqlite_binary: crsqlite-x86_64-unknown-linux-gnu.so
            bundle_name: linux-rpm
            bundle_args: --bundles rpm
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            rclone_url: https://downloads.rclone.org/rclone-current-linux-amd64.zip
            rclone_binary: rclone-x86_64-unknown-linux-gnu
            crsqlite_url: https://github.com/vlcn-io/cr-sqlite/releases/download/v0.16.3/crsqlite-linux-x86_64.zip
            crsqlite_binary: crsqlite-x86_64-unknown-linux-gnu.so
            bundle_name: linux-appimage
            bundle_args: --bundles appimage
          # Windows build
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            rclone_url: https://downloads.rclone.org/rclone-current-windows-amd64.zip
            rclone_binary: rclone-x86_64-pc-windows-msvc.exe
            crsqlite_url: https://github.com/vlcn-io/cr-sqlite/releases/download/v0.16.3/crsqlite-win-x86_64.zip
            crsqlite_binary: crsqlite-x86_64-pc-windows-msvc.dll
            bundle_name: windows-nsis
            bundle_args: ""
          # macOS builds
          - platform: macos-latest
            target: x86_64-apple-darwin
            rclone_url: https://downloads.rclone.org/rclone-current-osx-amd64.zip
            rclone_binary: rclone-x86_64-apple-darwin
            crsqlite_url: https://github.com/vlcn-io/cr-sqlite/releases/download/v0.16.3/crsqlite-darwin-x86_64.zip
            crsqlite_binary: crsqlite-x86_64-apple-darwin.dylib
            bundle_name: macos-x64
            bundle_args: ""
          - platform: macos-latest
            target: aarch64-apple-darwin
            rclone_url: https://downloads.rclone.org/rclone-current-osx-arm64.zip
            rclone_binary: rclone-aarch64-apple-darwin
            crsqlite_url: https://github.com/vlcn-io/cr-sqlite/releases/download/v0.16.3/crsqlite-darwin-aarch64.zip
            crsqlite_binary: crsqlite-aarch64-apple-darwin.dylib
            bundle_name: macos-arm64
            bundle_args: ""

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: apps/web/package.json

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: apps/web
        run: pnpm install --frozen-lockfile

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform }}-${{ matrix.target }}-release

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Download Rclone (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path apps/tauri/binaries
          Invoke-WebRequest -Uri "${{ matrix.rclone_url }}" -OutFile "rclone.zip"
          Expand-Archive -Path "rclone.zip" -DestinationPath "rclone-temp"
          $rcloneDir = Get-ChildItem -Path "rclone-temp" -Directory | Select-Object -First 1
          Copy-Item -Path "$($rcloneDir.FullName)/rclone.exe" -Destination "apps/tauri/binaries/${{ matrix.rclone_binary }}"

      - name: Download Rclone (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          mkdir -p apps/tauri/binaries
          curl -LO ${{ matrix.rclone_url }}
          unzip rclone-current-linux-amd64.zip
          cp rclone-*/rclone apps/tauri/binaries/${{ matrix.rclone_binary }}
          chmod +x apps/tauri/binaries/${{ matrix.rclone_binary }}

      - name: Download Rclone (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          mkdir -p apps/tauri/binaries
          curl -LO ${{ matrix.rclone_url }}
          unzip rclone-*.zip
          cp rclone-*/rclone apps/tauri/binaries/${{ matrix.rclone_binary }}
          chmod +x apps/tauri/binaries/${{ matrix.rclone_binary }}

      - name: Download CR-SQLite (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "${{ matrix.crsqlite_url }}" -OutFile "crsqlite.zip"
          Expand-Archive -Path "crsqlite.zip" -DestinationPath "crsqlite-temp"
          Copy-Item -Path "crsqlite-temp/crsqlite.dll" -Destination "apps/tauri/binaries/${{ matrix.crsqlite_binary }}"

      - name: Download CR-SQLite (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          curl -LO ${{ matrix.crsqlite_url }}
          unzip crsqlite-linux-x86_64.zip
          cp crsqlite.so apps/tauri/binaries/${{ matrix.crsqlite_binary }}
          chmod +x apps/tauri/binaries/${{ matrix.crsqlite_binary }}

      - name: Download CR-SQLite (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          curl -LO ${{ matrix.crsqlite_url }}
          unzip crsqlite-darwin-*.zip
          cp crsqlite.dylib apps/tauri/binaries/${{ matrix.crsqlite_binary }}
          chmod +x apps/tauri/binaries/${{ matrix.crsqlite_binary }}

      - name: Update version in tauri.conf.json
        run: |
          node -e "
            const fs = require('fs');
            const path = 'apps/tauri/tauri.conf.json';
            const config = JSON.parse(fs.readFileSync(path, 'utf8'));
            const version = '${{ needs.release.outputs.version }}';
            config.version = version;
            fs.writeFileSync(path, JSON.stringify(config, null, 4) + '\n');
            console.log('Updated version to: ' + version);
          "

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v${{ needs.release.outputs.version }}
          releaseName: "EchoVault v${{ needs.release.outputs.version }}"
          releaseBody: "See the assets section below to download the installer for your platform."
          releaseDraft: false
          prerelease: ${{ needs.release.outputs.is_prerelease == 'true' }}
          projectPath: apps/tauri
          args: --target ${{ matrix.target }} ${{ matrix.bundle_args }}
          tauriScript: pnpm tauri
          includeUpdaterJson: true
