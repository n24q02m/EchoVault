name: Release

on:
    push:
        branches: [main]

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        name: Release Please
        runs-on: ubuntu-latest
        outputs:
            release_created: ${{ steps.release.outputs.release_created }}
            tag_name: ${{ steps.release.outputs.tag_name }}

        steps:
            - name: Release Please
              id: release
              uses: googleapis/release-please-action@v4
              with:
                  config-file: release-please-config.json
                  manifest-file: .release-please-manifest.json

    build-tauri:
        name: Build Tauri App
        needs: release-please
        if: ${{ needs.release-please.outputs.release_created }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      rclone_url: https://downloads.rclone.org/rclone-current-linux-amd64.zip
                      rclone_binary: rclone-x86_64-unknown-linux-gnu
                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc
                      rclone_url: https://downloads.rclone.org/rclone-current-windows-amd64.zip
                      rclone_binary: rclone-x86_64-pc-windows-msvc.exe

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Install Linux dependencies
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "pnpm"
                  cache-dependency-path: src-web/pnpm-lock.yaml

            - name: Install frontend dependencies
              working-directory: src-web
              run: pnpm install --frozen-lockfile

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  key: ${{ matrix.platform }}-release

            - name: Download Rclone (Windows)
              if: matrix.platform == 'windows-latest'
              shell: pwsh
              run: |
                  Invoke-WebRequest -Uri "${{ matrix.rclone_url }}" -OutFile "rclone.zip"
                  Expand-Archive -Path "rclone.zip" -DestinationPath "rclone-temp"
                  $rcloneDir = Get-ChildItem -Path "rclone-temp" -Directory | Select-Object -First 1
                  Copy-Item -Path "$($rcloneDir.FullName)/rclone.exe" -Destination "src-tauri/binaries/${{ matrix.rclone_binary }}"

            - name: Download Rclone (Linux)
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  curl -LO ${{ matrix.rclone_url }}
                  unzip rclone-current-linux-amd64.zip
                  cp rclone-*/rclone src-tauri/binaries/${{ matrix.rclone_binary }}
                  chmod +x src-tauri/binaries/${{ matrix.rclone_binary }}

            - name: Build Tauri App
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: ${{ needs.release-please.outputs.tag_name }}
                  releaseName: "EchoVault ${{ needs.release-please.outputs.tag_name }}"
                  releaseBody: "See the assets section below to download the installer for your platform."
                  releaseDraft: false
                  prerelease: false
